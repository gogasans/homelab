# Flux Kustomization chain for all infrastructure components.
#
# Reconciliation order (dependsOn):
#   infra-controllers-vault
#     → infra-controllers-external-secrets
#         → infra-controllers-cert-manager
#             → infra-configs
#
# IMPORTANT: Vault starts sealed after every pod restart. The HelmRelease
# will reconcile (Helm install succeeds), but the ClusterSecretStore and
# any ExternalSecret resources will not function until Vault is manually
# unsealed. See docs/runbooks/vault-unseal.md.
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-controllers-vault
  namespace: flux-system
spec:
  interval: 10m
  path: ./kubernetes/infrastructure/controllers/vault
  prune: true
  retryInterval: 1m
  sourceRef:
    kind: GitRepository
    name: flux-system
  timeout: 5m
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-controllers-external-secrets
  namespace: flux-system
spec:
  dependsOn:
    - name: infra-controllers-vault
  interval: 10m
  path: ./kubernetes/infrastructure/controllers/external-secrets
  prune: true
  retryInterval: 1m
  sourceRef:
    kind: GitRepository
    name: flux-system
  timeout: 5m
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-controllers-cert-manager
  namespace: flux-system
spec:
  dependsOn:
    - name: infra-controllers-external-secrets
  interval: 10m
  path: ./kubernetes/infrastructure/controllers/cert-manager
  prune: true
  retryInterval: 1m
  sourceRef:
    kind: GitRepository
    name: flux-system
  timeout: 5m
---
# infra-configs depends on both cert-manager (for CRDs: ClusterIssuer, Certificate)
# and external-secrets (for ExternalSecret CRDs and ESO being running to sync secrets).
#
# postBuild substitutes ${ACME_EMAIL} and ${DOMAIN} at reconcile time from the
# cluster-vars ConfigMap. That ConfigMap is NOT in git — create it with:
#   task configure-cluster-vars
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-configs
  namespace: flux-system
spec:
  dependsOn:
    - name: infra-controllers-cert-manager
    - name: infra-controllers-external-secrets
  interval: 10m
  path: ./kubernetes/infrastructure/configs
  postBuild:
    substituteFrom:
      - kind: ConfigMap
        name: cluster-vars
  prune: true
  retryInterval: 1m
  sourceRef:
    kind: GitRepository
    name: flux-system
  timeout: 5m
