# ClusterSecretStore — ESO's authenticated connection to Vault
#
# This resource authenticates ESO to Vault using the Kubernetes auth method.
# No static token or credential is stored here — ESO's ServiceAccount token
# is presented to Vault, which validates it against the cluster's API server.
#
# IMPORTANT: This resource will fail to reconcile until:
#   1. Vault is initialized and unsealed (see docs/runbooks/vault-init.md)
#   2. The Kubernetes auth method is enabled in Vault
#   3. The ESO Vault role is configured in Vault
# All three are performed by scripts/vault-init.sh.

apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: vault-backend
spec:
  provider:
    vault:
      server: "http://vault.vault.svc.cluster.local:8200"
      path: "secret"      # KV v2 engine mount path
      version: "v2"       # KV v2 — paths include /data/ internally
      auth:
        kubernetes:
          mountPath: "kubernetes"   # Vault auth mount name (enabled in vault-init.sh)
          role: "external-secrets"  # Vault role name (created in vault-init.sh)
          serviceAccountRef:
            name: "external-secrets"
            namespace: "external-secrets"
