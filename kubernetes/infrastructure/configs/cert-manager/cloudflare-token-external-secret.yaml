# ExternalSecret â€” pulls the Cloudflare API token from Vault and creates a
# Kubernetes Secret in the cert-manager namespace.
#
# ESO syncs this every hour. If the token is rotated in Vault, the Secret
# is updated automatically without any cluster restart.
#
# The Secret name (cloudflare-api-token) is referenced directly by the
# ClusterIssuers in cluster-issuers.yaml.

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: cloudflare-api-token
  namespace: cert-manager
spec:
  data:
    - remoteRef:
        key: secret/cert-manager
        property: cloudflare_api_token
      secretKey: api-token
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault-backend
  target:
    creationPolicy: Owner
    name: cloudflare-api-token
