# Architecture

This document describes the high-level architecture of the homelab and how the components
interact. For the reasoning behind each technology choice, see [docs/adr/](adr/).

---

## Physical infrastructure

Two bare metal machines run Proxmox VE as the hypervisor. Each hosts one VM:

```
┌─────────────────────────────────────────────────────────────────────┐
│  Physical Network (LAN)                                             │
│                                                                     │
│  ┌───────────────────────┐       ┌───────────────────────┐          │
│  │  Proxmox Host: pve1   │       │  Proxmox Host: pve2   │          │
│  │  ┌─────────────────┐  │       │  ┌─────────────────┐  │          │
│  │  │ VM: k3s-cp-01   │  │       │  │ VM: k3s-wk-01   │  │          │
│  │  │ Control Plane   │  │       │  │ Worker Node     │  │          │
│  │  │ Ubuntu 24.04    │  │       │  │ Ubuntu 24.04    │  │          │
│  │  │ 4 vCPU / 8 GB   │  │       │  │ 6 vCPU / 16 GB  │  │          │
│  │  │ 50 GB OS disk   │◄─┼───────┼─►│ 50 GB OS disk   │  │          │
│  │  │ 100 GB data disk│  │ k3s   │  │ 100 GB data disk│  │          │
│  │  └─────────────────┘  │       │  └─────────────────┘  │          │
│  └───────────────────────┘       └───────────────────────┘          │
│                                                                     │
│  Developer Machine (this machine)                                   │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │  OpenTofu  │  Ansible  │  kubectl  │  flux CLI  │  SOPS     │    │
│  └─────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Bootstrap sequence

Infrastructure is built in layered phases. Each layer depends on the previous:

```
┌─────────────────────────────────────────────┐
│  Phase 0: Git repository + CI               │
│  Structure, rules, ADRs, GitHub Actions     │
└──────────────────────┬──────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────┐
│  Phase 1: OpenTofu                          │
│  Provision VMs on Proxmox via bpg provider  │
│  → 2 Ubuntu 24.04 VMs with static IPs       │
└──────────────────────┬──────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────┐
│  Phase 2: Ansible                           │
│  OS hardening + k3s installation            │
│  → Healthy 2-node k3s cluster               │
└──────────────────────┬──────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────┐
│  Phase 3: FluxCD                            │
│  Bootstrap GitOps operator                  │
│  → git push = cluster reconcile             │
└──────────────────────┬──────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────┐
│  Phase 4: Core controllers                  │
│  cert-manager + Traefik + TLS               │
│  → Services exposed at https://*.domain     │
└──────────────────────┬──────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────┐
│  Phase 5: Observability                     │
│  Prometheus + Grafana + Loki + Alloy        │
│  → Metrics and logs visible                 │
└──────────────────────┬──────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────┐
│  Phase 6: Storage                           │
│  local-path-provisioner → Longhorn          │
│  → Replicated volumes across 2 nodes        │
└──────────────────────┬──────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────┐
│  Phase 7+: Applications                     │
│  Real self-hosted services                  │
└─────────────────────────────────────────────┘
```

---

## GitOps flow

After Phase 3, all changes to the cluster flow through git:

```
Developer
   │
   │  git push / PR merge
   ▼
GitHub repository
   │
   │  FluxCD watches (interval: 1m)
   ▼
FluxCD source-controller
   │  pulls new commits
   ▼
FluxCD kustomize-controller
   │  decrypts SOPS secrets
   │  applies kustomize overlays
   ▼
FluxCD helm-controller
   │  applies/upgrades HelmRelease resources
   ▼
Kubernetes cluster
```

---

## Kubernetes directory structure

```
kubernetes/
├── clusters/homelab/        ← FluxCD entry point
│   ├── flux-system/         ← Auto-generated by flux bootstrap
│   ├── infrastructure.yaml  ← Flux Kustomization: reconciles infrastructure/
│   └── apps.yaml            ← Flux Kustomization: reconciles apps/ (dependsOn infra)
│
├── infrastructure/
│   ├── controllers/         ← Helm-based platform components
│   │   ├── traefik/
│   │   ├── cert-manager/
│   │   ├── longhorn/
│   │   └── monitoring/
│   └── configs/             ← CRD resources (depend on controllers being ready)
│       ├── cert-manager/    ← ClusterIssuers, SOPS-encrypted API tokens
│       └── traefik/         ← Middlewares
│
└── apps/
    ├── base/                ← Environment-agnostic base manifests
    └── homelab/             ← Homelab-specific kustomize overlays
```

**Reconciliation ordering** (enforced via `dependsOn`):

```
infrastructure.yaml (controllers)
        │
        └── dependsOn: (nothing — reconciles first)

infrastructure-configs.yaml
        │
        └── dependsOn: infrastructure.yaml

apps.yaml
        │
        └── dependsOn: infrastructure-configs.yaml
```

---

## Known limitations

**No high-availability control plane**

A single control plane node means that if `k3s-cp-01` is unavailable, the Kubernetes
API is unavailable. Existing workloads on the worker node continue to run (the kubelet
does not require the API server for running pods), but no new pods can be scheduled and
no configuration changes can be applied.

A proper HA k3s cluster requires 3 control plane nodes (for etcd quorum: `(3/2)+1 = 2`).
With 2 physical Proxmox hosts, this would require running 2 control plane VMs on one host,
which creates a different HA problem (physical host as a single point of failure for 2/3
of the quorum).

**Resolution path:** Add a third Proxmox host. This is called out as future work.
See [ADR 009](adr/009-single-cp-not-ha.md).
