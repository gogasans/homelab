name: Docs Check

on:
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  component-readme:
    name: New component directories must have a README
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for missing READMEs
        run: |
          FAILED=0

          # Get directories added in this PR (depth 3 = component level)
          ADDED_DIRS=$(git diff --name-only origin/${{ github.base_ref }}...HEAD \
            | grep -E '^(tofu/modules|kubernetes/infrastructure/controllers|kubernetes/apps/base)/' \
            | awk -F/ '{print $1"/"$2"/"$3}' \
            | sort -u)

          for dir in $ADDED_DIRS; do
            if [ -d "$dir" ] && [ ! -f "$dir/README.md" ]; then
              echo "MISSING README: $dir/README.md"
              FAILED=1
            fi
          done

          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "Every new component directory must include a README.md explaining:"
            echo "  - What this component does"
            echo "  - Why it was chosen (or link to ADR)"
            echo "  - Key configuration decisions"
            exit 1
          fi

          echo "All component directories have README files."
