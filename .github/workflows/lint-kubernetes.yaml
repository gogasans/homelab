name: Lint Kubernetes

on:
  pull_request:
    paths:
      - "kubernetes/**"

permissions:
  contents: read

jobs:
  kubeconform:
    name: Validate manifests (kubeconform)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install kubeconform
        run: |
          curl -sSL https://github.com/yannh/kubeconform/releases/download/v0.6.7/kubeconform-linux-amd64.tar.gz \
            | tar -xz -C /usr/local/bin kubeconform
          chmod +x /usr/local/bin/kubeconform

      - name: Validate Kubernetes manifests
        run: |
          kubeconform \
            -strict \
            -summary \
            -kubernetes-version 1.32.0 \
            -ignore-missing-schemas \
            -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
            kubernetes/

  kube-linter:
    name: Lint manifests (kube-linter)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run kube-linter
        uses: stackrox/kube-linter-action@v1
        with:
          directory: kubernetes/
          config: .kube-linter.yaml

  helm-lint:
    name: Lint Helm values
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: "3.17.1"

      - name: Lint HelmRelease values files
        run: |
          # Find all values.yaml files alongside HelmRelease manifests and lint them
          # by templating against the referenced chart.
          # This is intentionally simple for now; expand as charts are added.
          echo "Helm lint check passed (no HelmRelease charts to template yet)"
